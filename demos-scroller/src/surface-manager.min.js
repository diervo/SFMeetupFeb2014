!function(a){"use strict";function b(){}var c=a.__S||(a.__S={}),d=c.plugins||(c.plugins={}),e=c.styles,f=c.helpers,g=a.requestAnimationFrame,h=10;b.prototype={init:function(){this.surfacesPositioned=[],this.surfacesPool=[],this.items=[],this.on("_initialize",this._initializeSurfaceManager),this.on("_update",this._updateSurfaceManager),this.on("destroy",this._destroySurfaceManager)},_initializeSurfaceManager:function(){this._bootstrapItems(),this._initializeSurfaces(),this._setActiveOffset(),this._initializePositions(),this._setInfiniteScrollerSize()},_destroySurfaceManager:function(){var b=a.document.createDocumentFragment();this.items.forEach(function(a){b.appendChild(a.dom)}),this.scroller.innerHTML="",this.scroller.appendChild(b),this.items=[],this.surfacesPool=[],this.surfacesPositioned=[]},_bootstrapItems:function(){var a,b,c=this.opts.pullToRefresh?1:0,d=Array.prototype.slice.call(this.scroller.children,c),e=d.length,f=[];if(e)for(b=0;e>b;b++)a=d[b],f[b]={dom:a},this.scroller.removeChild(a);this.items=f},_setActiveOffset:function(){this.activeOffset=.9*(this.scrollVertical?this.wrapperHeight:this.wrapperWidth)},_initializePositions:function(){for(var a,b,c=this.items,d=this.scrollVertical?this.wrapperHeight:this.wrapperWidth,e=this.surfacesPositioned,f=c.length,g=!0,h=d+2*this.activeOffset,i=0,j=0;f>j&&g;j++)a=c[j],b=this._getAvailableSurface(),i+=this._attachItemInSurface(a,b,{index:j,offset:i}),g=h>i,e[j]=b},_createSurfaceDOM:function(b,c){b||(b={});var d=a.document.createElement("div"),f=d.style;return d.className=b.class?"surface "+b.class:"surface",f.height=b.height&&b.height+"px",f.width=b.width&&b.width+"px",f[e.transform]="scale3d(0.0001, 0.0001, 1)",c&&d.appendChild(c),d},_createSurface:function(a,b){a||(a={});var c=this._createSurfaceDOM(a,b);return{dom:c,contentIndex:a.index,content:b,state:0,offset:0,width:0,height:0}},_createSurfaces:function(a,b){b||(b={});var c,d=[];for(c=0;a>c;c++)d.push(this._createSurface(b));return d},_getSurfaceTotalOffset:function(a){return a.offset+(this.scrollVertical?a.height:a.width)},_attachItemInSurface:function(a,b,c){var d,f,g=c.offset,h=c.index,i=0,j=0;return b.dom.appendChild(a.dom),f=b.dom.offsetHeight,d=b.dom.offsetWidth,this.scrollVertical?j=c.preCalculateSize?g-f:g:i=c.preCalculateSize?g-d:g,b.dom.style[e.transform]="matrix3d(1,0,0,0,0,1,0,0,0,0,1,0,"+i+","+j+", 0, 1)",b.state=1,b.contentIndex=h,b.content=a,b.height=f,b.width=d,b.offset=j||i,this.scrollVertical?f:d},_dettachItemInSurface:function(a){a.state=0,a.contentIndex=null,a.content=null,a.height=null,a.width=null,a.offset=null,a.dom.removeChild(a.dom.firstChild)},_attachSurfaces:function(b){var c,d,e=a.document.createDocumentFragment();for(d=0;d<b.length;d++)c=b[d],e.appendChild(c.dom),this.surfacesPool.push(c);this.scroller.appendChild(e)},_getAvailableSurface:function(){for(var a,b,c=this.surfacesPool,d=0;d<c.length;d++)if(b=c[d],!b.state)return b;return a=this._createSurfaces(1),this._attachSurfaces(a),this._getAvailableSurface()},_emptyScroller:function(){return!(this.opts.pullToLoadMore?this.items.length-1:this.items.length)},_initializeSurfaces:function(){var a=this.items,b=Math.min(h,a.length),c=this._createSurfaces(b);this._attachSurfaces(c)},_resetSurfaces:function(){for(var a,b=this.surfacesPositioned,c=b.length,d=0;c>d;d++)a=b.shift(),this._dettachItemInSurface(a)},_mod:function(a){return a},_positionBeingUsed:function(a){var b=this._positionedSurfacesFirst(),c=this._positionedSurfacesLast();return a===b.contentIndex||a===c.contentIndex},_positionedSurfacesFirst:function(){return this.surfacesPositioned[0]},_positionedSurfacesLast:function(){var a=this.surfacesPositioned;return a[a.length-1]},_positionedSurfacesPush:function(){var a,b=this._positionedSurfacesLast(),c=this._getSurfaceTotalOffset(b),d=this._mod(b.contentIndex+1),e={index:d,offset:c};return this._positionBeingUsed(d)?b:(a=this._getAvailableSurface(),this._attachItemInSurface(this.items[d],a,e),this.surfacesPositioned.push(a),DEBUG.log("PUSH   ",Date.now()),a)},_positionedSurfacesPop:function(){DEBUG.log("POP    ",Date.now());var a=this.surfacesPositioned.pop();return this._dettachItemInSurface(a),this._positionedSurfacesLast()},_positionedSurfacesUnshift:function(){var a,b=this._positionedSurfacesFirst(),c=this._mod(b.contentIndex-1),d={index:c,offset:b.offset,preCalculateSize:!0};return this._positionBeingUsed(c)?b:(a=this._getAvailableSurface(),this._attachItemInSurface(this.items[c],a,d),this.surfacesPositioned.unshift(a),DEBUG.log("UNSHIFT",Date.now()),a)},_positionedSurfacesShift:function(){DEBUG.log("SHIFT  ",Date.now());var a=this.surfacesPositioned.shift();return this._dettachItemInSurface(a),this._positionedSurfacesFirst()},_itemsLeft:function(a){var b,c=this._positionedSurfacesFirst().contentIndex,d=this._positionedSurfacesLast().contentIndex,e=this.items.length-1;return b="top"===a?c>0:"bottom"===a?e>d:c>0||e>d},_getBoundaries:function(a,b){var c=this.activeOffset,d=Math.abs(a);return{top:d-c>0?d-c:0,bottom:d+b+c}},_updateAllowed:function(a){return a.pos<0&&(this._isScrolling||Math.abs(a.dist)>10)},_recycleSurface:function(){return!0},_getPosition:function(){return this.scrollVertical?{pos:this.y,dist:this.distY,size:this.wrapperHeight,maxScroll:this.maxScrollY}:{pos:this.x,dist:this.distX,size:this.wrapperWidth,maxScroll:this.maxScrollX}},_updateSurfaceManager:function(){if(!this._emptyScroller()){var a,b=this,c=this._getPosition(),d=this._getBoundaries(c.pos,c.size),e=this._itemsLeft("bottom"),f=this._positionedSurfacesFirst(),h=this._getSurfaceTotalOffset(f),i=this._positionedSurfacesLast(),j=i.offset,k=!1,l=!1;if(this._updateAllowed(c)){if(this._isScrolling&&!e&&c.pos<c.maxScroll-c.size/4&&(this._isAnimating=!1,this._isScrolling=!1,this._stopMomentum(),g(function(){b._resetPosition(b.opts.bounceTime)})),c.dist<0){for(;this._itemsLeft("bottom")&&j<d.bottom&&!l;)a=this._positionedSurfacesPush(),a===i?l=!0:(i=a,j=i.offset,k=!0);if(k)return this._setInfiniteScrollerSize();for(;d.top>h&&this._recycleSurface("top");)f=this._positionedSurfacesShift(),h=this._getSurfaceTotalOffset(f),k=!0}else{for(;f.offset>d.top&&!l;)a=this._positionedSurfacesUnshift(),a===f?l=!0:(f=a,h=this._getSurfaceTotalOffset(f),k=!0);if(k)return this._setInfiniteScrollerSize();for(;j>d.bottom&&this._itemsLeft("top")&&this._recycleSurface("bottom");)i=this._positionedSurfacesPop(),j=i.offset,k=!0}return k?this._setInfiniteScrollerSize():void 0}}},_setInfiniteScrollerSize:function(){var a,b,c=this.surfacesPositioned,d=this.items,e=this.scrollVertical?this.wrapperHeight:this.wrapperWidth,f=this.opts.pullToLoadMore&&this._ptlIsEnabled(),g=f?c.length-2:c.length-1,h=c[g],i=this.opts.pullToLoadMore?d.length-1:d.length;c.length<=0||(a=h.contentIndex<i-1,b=h.offset+(this.scrollVertical?h.height:h.width),this.scrollVertical?this.maxScrollY=a?Number.NEGATIVE_INFINITY:e-b:this.maxScrollX=a?Number.NEGATIVE_INFINITY:e-b,this.hasScrollY=this.maxScrollY<0,this.hasScrollX=this.maxScrollX<0,this._testPullToShowMore())},_appendPullToLoad:function(){var a=this._createPullToLoadMarkup();this.items.push({ptl:!0,dom:a}),this.ptlDOM=a,this.ptlIcon=a.firstChild,this._ptlSnapTime=200,this._ptlEnabled=!0,this.maxScrollY>=0&&this._ptlToggle("disable")},resize:function(){var a=this;this._stopMomentum(),g(function(){a._setWrapperSize(),a.refresh(),a._scrollTo(0,0)})},refresh:function(){this._resetSurfaces(),this._initializePositions(),this._setInfiniteScrollerSize()},_prependData:function(a){var b,c;for(c=0;c<a.length;c++)b={dom:a[c]},this.items.unshift(b)},_appendData:function(a){var b,c,d;for(this.opts.pullToLoadMore&&(b=this.items.pop(),this._positionedSurfacesPop()),d=0;d<a.length;d++)c={dom:a[d]},this.items.push(c);this.opts.pullToLoadMore&&this.items.push(b)},prependItems:function(a){var b=f.parseDOM(a);this._prependData(b),this.refresh()},appendItems:function(a){var b=f.parseDOM(a);this._appendData(b),this._updateSurfaceManager()}},c.SurfaceManager=d.SurfaceManager=b}(window);